{% extends "tracker/base.html" %}
{% block title %}Financial Insights - FinTrack{% endblock %}
{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 20px;">
    <h1 style="color: #2c3e50; margin-bottom: 10px;">ğŸ’° Financial Insights Dashboard</h1>
    <p style="color: #7f8c8d; margin-bottom: 30px;">
        Filter your transactions and see spending patterns
    </p>
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
        <h2 style="color: #34495e; margin-top: 0;">ğŸ” Filter Transactions</h2>

        <form method="get" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Search (merchant/notes):</label>
                <input type="text" name="q" value="{{ search_query }}"
                       placeholder="e.g., Starbucks"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Category:</label>
                <select name="category" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                        <option value="{{ cat.id }}" {% if category_filter == cat.id|stringformat:"s" %}selected{% endif %}>
                            {{ cat.name }} ({{ cat.type }})
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Date From:</label>
                <input type="date" name="date_from" value="{{ date_from }}"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Date To:</label>
                <input type="date" name="date_to" value="{{ date_to }}"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Min Amount ($):</label>
                <input type="number" step="0.01" name="min_amount" value="{{ min_amount }}"
                       placeholder="0.00"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div>
                <label style="display: block; margin-bottom: 5px; font-weight: bold; color: #555;">Max Amount ($):</label>
                <input type="number" step="0.01" name="max_amount" value="{{ max_amount }}"
                       placeholder="1000.00"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>

            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <button type="submit"
                        style="background: #3498db; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">
                    Apply Filters
                </button>
                <a href="{% url 'transaction_insights' %}"
                   style="background: #95a5a6; color: white; padding: 10px 20px; text-decoration: none; border-radius: 4px; display: inline-block;">
                    Clear
                </a>
            </div>
        </form>

        {% if has_filters %}
        <p style="margin-top: 15px; color: #27ae60; font-weight: bold;">
            âœ“ Filters applied - Showing {{ total_transactions }} result{{ total_transactions|pluralize }}
        </p>
        {% endif %}
    </div>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px;">

        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 8px; color: white;">
            <h3 style="margin-top: 0;">ğŸ“Š Overall Stats</h3>
            <p style="font-size: 14px; margin: 5px 0;">Total Transactions: <strong>{{ total_transactions }}</strong></p>
            <p style="font-size: 14px; margin: 5px 0;">Total Amount: <strong>${{ total_spent|floatformat:2 }}</strong></p>
            <p style="font-size: 14px; margin: 5px 0;">Average: <strong>${{ average_transaction|floatformat:2 }}</strong></p>
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
            <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“ By Category</h3>
            {% if category_breakdown %}
                {% for item in category_breakdown %}
                <div style="margin-bottom: 15px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <span style="font-weight: bold; color: #34495e;">{{ item.category__name }}</span>
                        <span style="color: #7f8c8d;">${{ item.total|floatformat:2 }}</span>
                    </div>
                    <div style="background: #ecf0f1; height: 8px; border-radius: 4px; overflow: hidden;">
                        <div style="background: {% if item.category__type == 'EXPENSE' %}#e74c3c{% else %}#2ecc71{% endif %};
                                    height: 100%; width: {{ item.percentage|floatformat:0 }}%;"></div>
                    </div>
                    <p style="font-size: 12px; color: #95a5a6; margin: 3px 0;">
                        {{ item.count }} transaction{{ item.count|pluralize }} Â· Avg: ${{ item.avg_amount|floatformat:2 }}
                    </p>
                </div>
                {% endfor %}
            {% else %}
                <p style="color: #95a5a6; font-style: italic;">No categories to display</p>
            {% endif %}
        </div>

        <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
            <h3 style="margin-top: 0; color: #2c3e50;">ğŸª Top Merchants</h3>
            {% if top_merchants %}
                <ol style="padding-left: 20px; margin: 0;">
                {% for merchant in top_merchants %}
                    <li style="margin-bottom: 10px;">
                        <strong>{{ merchant.merchant }}</strong><br>
                        <span style="color: #7f8c8d; font-size: 14px;">
                            ${{ merchant.total_spent|floatformat:2 }}
                            ({{ merchant.transaction_count }} visit{{ merchant.transaction_count|pluralize }})
                        </span>
                    </li>
                {% endfor %}
                </ol>
            {% else %}
                <p style="color: #95a5a6; font-style: italic;">No merchant data available</p>
            {% endif %}
        </div>
    </div>

    {% if monthly_spending %}
    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0; margin-bottom: 30px;">
        <h3 style="margin-top: 0; color: #2c3e50;">ğŸ“ˆ Monthly Spending Trends</h3>
        <table style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                    <th style="padding: 10px; text-align: left;">Month</th>
                    <th style="padding: 10px; text-align: right;">Total Spent</th>
                    <th style="padding: 10px; text-align: right;">Transactions</th>
                    <th style="padding: 10px; text-align: right;">Avg per Transaction</th>
                </tr>
            </thead>
            <tbody>
                {% for month in monthly_spending %}
                <tr style="border-bottom: 1px solid #e0e0e0;">
                    <td style="padding: 10px;">{{ month.month|date:"F Y" }}</td>
                    <td style="padding: 10px; text-align: right; font-weight: bold;">${{ month.total|floatformat:2 }}</td>
                    <td style="padding: 10px; text-align: right;">{{ month.count }}</td>
                    <td style="padding: 10px; text-align: right;">${{ month.total|floatformat:2|default:"0.00" }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% endif %}

    <div style="background: white; padding: 20px; border-radius: 8px; border: 2px solid #e0e0e0;">
        <h2 style="color: #2c3e50; margin-top: 0;">ğŸ“‹ Transaction List</h2>

        {% if transactions %}
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
                        <th style="padding: 10px; text-align: left;">Date</th>
                        <th style="padding: 10px; text-align: left;">Merchant</th>
                        <th style="padding: 10px; text-align: left;">Category</th>
                        <th style="padding: 10px; text-align: right;">Amount</th>
                        <th style="padding: 10px; text-align: left;">Notes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaction in transactions %}
                    <tr style="border-bottom: 1px solid #e0e0e0;">
                        <td style="padding: 10px;">{{ transaction.date|date:"M d, Y" }}</td>
                        <td style="padding: 10px;">{{ transaction.merchant|default:"â€”" }}</td>
                        <td style="padding: 10px;">
                            <span style="background: {% if transaction.category.type == 'EXPENSE' %}#fee{% else %}#efe{% endif %};
                                         padding: 3px 8px; border-radius: 3px; font-size: 12px;">
                                {{ transaction.category.name }}
                            </span>
                        </td>
                        <td style="padding: 10px; text-align: right; font-weight: bold;
                                   color: {% if transaction.category.type == 'EXPENSE' %}#e74c3c{% else %}#2ecc71{% endif %};">
                            ${{ transaction.amount|floatformat:2 }}
                        </td>
                        <td style="padding: 10px; color: #7f8c8d; font-size: 14px;">
                            {{ transaction.notes|truncatewords:10|default:"â€”" }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if is_paginated %}
            <div style="margin-top: 20px; text-align: center;">
                {% if page_obj.has_previous %}
                    <a href="?page=1" style="padding: 8px 12px; margin: 0 5px; text-decoration: none; color: #3498db;">Â« First</a>
                    <a href="?page={{ page_obj.previous_page_number }}" style="padding: 8px 12px; margin: 0 5px; text-decoration: none; color: #3498db;">â€¹ Previous</a>
                {% endif %}

                <span style="padding: 8px 12px; margin: 0 5px;">
                    Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                </span>

                {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}" style="padding: 8px 12px; margin: 0 5px; text-decoration: none; color: #3498db;">Next â€º</a>
                    <a href="?page={{ page_obj.paginator.num_pages }}" style="padding: 8px 12px; margin: 0 5px; text-decoration: none; color: #3498db;">Last Â»</a>
                {% endif %}
            </div>
            {% endif %}

        {% empty %}
            <div style="text-align: center; padding: 40px; color: #95a5a6;">
                <p style="font-size: 48px; margin: 0;">ğŸ”</p>
                <h3 style="margin: 10px 0;">No transactions found</h3>
                <p style="margin: 5px 0;">
                    {% if has_filters %}
                        Try adjusting your filters or <a href="{% url 'transaction_insights' %}" style="color: #3498db;">clear all filters</a>
                    {% else %}
                        Start by adding some transactions in the admin panel
                    {% endif %}
                </p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}